<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>学生动态轨迹</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(to right, #ece9e6, #ffffff);
        }
        #app, #container {
            width: 100%;
            height: 100%;
        }
        .marker-form {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 999;
            max-width: 400px;
        }
        .map-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .thumbnail-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        .el-dialog__body img {
            max-width: 95vw;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 15px;
        }
        .el-dialog__body {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-radius: 15px;
            box-shadow: none;
            border: none;
        }
        .el-dialog__header {
            display: none;
        }
        .image-item {
            position: relative;
            display: inline-block;
        }
        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
        }
        .image-item:hover .image-actions {
            display: block;
        }
        .el-upload--picture-card {
            width: 100px;
            height: 100px;
            line-height: 100px;
        }
        @media (max-width: 768px) {
            .marker-form, .map-controls {
                top: 10px;
                right: 10px;
                left: 10px;
                padding: 15px;
                max-width: calc(100% - 20px);
            }
            .thumbnail {
                width: 80px;
                height: 80px;
            }
        }
        /* 修改自定义标记点样式 */
        .custom-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .custom-marker:hover {
            transform: scale(1.1);
        }
        .custom-marker.sufficient {
            background-color: #409EFF;  /* 蓝色表示数量充足 */
        }
        .custom-marker.sufficient:hover {
            background-color: #66b1ff;
        }
        .custom-marker.insufficient {
            background-color: #F56C6C;  /* 红色表示数量不足 */
        }
        .custom-marker.insufficient:hover {
            background-color: #f78989;
        }
        /* 添加图片预览相关样式 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-in-out;
        }
        .overlay img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            animation: zoomIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* 移除 el-dialog 的背景和边框 */
        .el-dialog {
            background: transparent !important;
            box-shadow: none !important;
        }
        .el-dialog__body {
            padding: 0 !important;
            background: transparent !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="container"></div>
        <div class="map-controls">
            <el-button-group>
                <el-button 
                    :type="mapType === 'normal' ? 'primary' : ''" 
                    size="small" 
                    @click="switchMapType('normal')">
                    2D地图
                </el-button>
                <el-button 
                    :type="mapType === 'satellite' ? 'primary' : ''" 
                    size="small" 
                    @click="switchMapType('satellite')">
                    卫星图
                </el-button>
            </el-button-group>
            <el-button type="danger" size="small" @click="logout" style="margin-left: 10px;">退出登录</el-button>
        </div>
        <div class="marker-form" v-if="showForm">
            <el-form :model="form" label-width="120px">
                <el-form-item label="当前数量">
                    <el-input-number 
                        v-model="form.value" 
                        :min="0"
                        :step="1"
                        :precision="0"
                        controls-position="right"
                        style="width: 100%;">
                    </el-input-number>
                </el-form-item>
                <el-form-item label="需要的数量">
                    <el-input-number 
                        v-model="form.required_value" 
                        :min="0"
                        :step="1"
                        :precision="0"
                        controls-position="right"
                        style="width: 100%;">
                    </el-input-number>
                </el-form-item>
                <el-form-item v-if="isExistingMarker && form.images && form.images.length > 0" label="已有图片">
                    <div class="thumbnail-container">
                        <div v-for="image in form.images" :key="image" class="image-item">
                            <img
                                :src="'/uploads/' + image"
                                class="thumbnail"
                                @click="showLargeImage(image)"
                            >
                            <div class="image-actions">
                                <el-button type="danger" size="mini" icon="el-icon-delete" circle @click="deleteImage(image)"></el-button>
                            </div>
                        </div>
                    </div>
                </el-form-item>
                <el-form-item label="添加图片">
                    <el-upload
                        action=""
                        :auto-upload="false"
                        :on-change="handleFileChange"
                        :on-remove="handleFileRemove"
                        multiple
                        list-type="picture-card">
                        <i class="el-icon-plus"></i>
                    </el-upload>
                </el-form-item>
                <el-form-item>
                    <template v-if="isExistingMarker">
                        <el-button type="primary" @click="updateMarker">保存</el-button>
                        <el-button type="danger" @click="deleteMarker">删除</el-button>
                        <el-button @click="closeForm">取消</el-button>
                    </template>
                    <template v-else>
                        <el-button type="primary" @click="submitMarker">保存</el-button>
                        <el-button @click="closeForm">取消</el-button>
                    </template>
                </el-form-item>
            </el-form>
        </div>

        <el-dialog :visible.sync="dialogVisible" append-to-body width="80%" :modal="true" :show-close="false" custom-class="image-preview-dialog">
            <div class="overlay" @click.self="dialogVisible = false">
                <img 
                    :src="'/uploads/' + currentImage" 
                    alt="预览图"
                    ref="previewImg"
                    :style="{
                        transform: 'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + scale + ')',
                        transition: dragging ? 'none' : 'transform 0.2s',
                        cursor: dragging ? 'grabbing' : 'grab',
                        'user-select': 'none'
                    }"
                    @wheel.stop.prevent="onWheel"
                    @mousedown.stop.prevent="onMouseDown"
                    @mousemove.stop.prevent="onMouseMove"
                    @mouseup.stop.prevent="onMouseUp"
                    @mouseleave.stop.prevent="onMouseUp"
                >
            </div>
        </el-dialog>
    </div>

    <script src="https://webapi.amap.com/maps?v=2.0&key=a72c3ace8f83aee4b962e88bfdaed2d0&plugin=AMap.MapType,AMap.Scale"></script>
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                map: null,
                marker: null,
                showForm: false,
                isExistingMarker: false,
                dialogVisible: false,
                currentImage: '',
                mapType: 'normal',
                form: {
                    id: null,
                    latitude: null,
                    longitude: null,
                    value: 0,
                    required_value: 0,
                    files: [],
                    images: []
                },
                // 添加图片缩放和拖拽相关的数据
                scale: 1,
                translateX: 0,
                translateY: 0,
                dragging: false,
                dragStartX: 0,
                dragStartY: 0,
                imgStartX: 0,
                imgStartY: 0
            },
            watch: {
                dialogVisible(val) {
                    if (val) {
                        this.scale = 1;
                        this.translateX = 0;
                        this.translateY = 0;
                    }
                }
            },
            mounted() {
                // 检查登录状态
                if (localStorage.getItem('isLoggedIn') !== 'true') {
                    window.location.href = '/login';
                    return;
                }
                this.initMap();
            },
            methods: {
                initMap() {
                    this.map = new AMap.Map('container', {
                        zoom: 18,
                        center: [114.390521, 30.454407],
                        viewMode: '2D'
                    });

                    // 添加图层切换控件
                    var layers = [
                        new AMap.TileLayer(),
                        new AMap.TileLayer.Satellite()
                    ];
                    this.map.addLayer(layers[0]);

                    this.loadMarkers();

                    this.map.on('click', (e) => {
                        const lnglat = e.lnglat;
                        if (this.marker) {
                            this.marker.setMap(null);
                        }

                        // 创建新标记点时使用自定义样式
                        const markerContent = document.createElement('div');
                        markerContent.className = 'custom-marker insufficient';
                        markerContent.innerHTML = '0';

                        this.marker = new AMap.Marker({
                            position: [lnglat.getLng(), lnglat.getLat()],
                            map: this.map,
                            content: markerContent,
                            offset: new AMap.Pixel(-15, -15)
                        });

                        this.form.latitude = lnglat.getLat();
                        this.form.longitude = lnglat.getLng();
                        this.showForm = true;
                        this.isExistingMarker = false;
                        this.form.value = 0;
                        this.form.required_value = 0;
                        this.form.files = [];
                        this.form.images = [];
                    });
                },
                switchMapType(type) {
                    this.mapType = type;
                    if (type === 'normal') {
                        this.map.setLayers([new AMap.TileLayer()]);
                    } else {
                        this.map.setLayers([new AMap.TileLayer.Satellite()]);
                    }
                },
                loadMarkers() {
                    // 清除所有现有标记点
                    if (this.map) {
                        this.map.clearMap();
                    }

                    axios.get('/api/markers')
                        .then(response => {
                            response.data.forEach(marker => {
                                // 创建自定义标记点内容
                                const markerContent = document.createElement('div');
                                markerContent.className = 'custom-marker ' + 
                                    (marker.value >= marker.required_value ? 'sufficient' : 'insufficient');
                                markerContent.innerHTML = marker.value.toString();

                                const markerObj = new AMap.Marker({
                                    position: [marker.longitude, marker.latitude],
                                    map: this.map,
                                    content: markerContent,
                                    offset: new AMap.Pixel(-15, -15)
                                });

                                markerObj.on('click', () => {
                                    this.form.id = marker.id;
                                    this.form.latitude = marker.latitude;
                                    this.form.longitude = marker.longitude;
                                    this.form.value = marker.value;
                                    this.form.required_value = marker.required_value;
                                    this.form.images = marker.images || [];
                                    this.showForm = true;
                                    this.isExistingMarker = true;
                                });
                            });
                        })
                        .catch(error => {
                            console.error('加载标记点失败:', error);
                            this.$message.error('加载标记点失败');
                        });
                },
                handleFileChange(file) {
                    this.form.files.push(file.raw);
                },
                handleFileRemove(file) {
                    const index = this.form.files.findIndex(f => f === file.raw);
                    if (index > -1) {
                        this.form.files.splice(index, 1);
                    }
                },
                showLargeImage(image) {
                    this.currentImage = image;
                    this.dialogVisible = true;
                },
                async submitMarker() {
                    try {
                        const markerResponse = await axios.post('/api/markers', {
                            latitude: this.form.latitude,
                            longitude: this.form.longitude,
                            value: this.form.value,
                            required_value: this.form.required_value
                        });

                        if (this.form.files.length > 0) {
                            const formData = new FormData();
                            this.form.files.forEach(file => {
                                formData.append('images', file);
                            });
                            await axios.post(`/api/markers/${markerResponse.data.id}/images`, formData);
                        }

                        this.$message.success('保存成功');
                        this.closeForm();
                        this.loadMarkers();
                    } catch (error) {
                        this.$message.error('保存失败');
                        console.error(error);
                    }
                },
                async deleteMarker() {
                    try {
                        await this.$confirm('确定要删除这个点位吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await axios.delete(`/api/markers/${this.form.id}`);
                        this.$message.success('删除成功');
                        this.closeForm();
                        await this.loadMarkers();
                    } catch (error) {
                        if (error === 'cancel') return;
                        this.$message.error('删除失败：' + (error.response?.data?.error || '未知错误'));
                        console.error(error);
                    }
                },
                async deleteImage(filename) {
                    try {
                        await this.$confirm('确定要删除这张图片吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await axios.delete(`/api/markers/${this.form.id}/images/${filename}`);
                        this.$message.success('删除成功');
                        
                        // 从列表中移除已删除的图片
                        const index = this.form.images.indexOf(filename);
                        if (index > -1) {
                            this.form.images.splice(index, 1);
                        }
                    } catch (error) {
                        if (error === 'cancel') return;
                        this.$message.error('删除失败：' + (error.response?.data?.error || '未知错误'));
                        console.error(error);
                    }
                },
                async updateMarker() {
                    try {
                        // 更新基本信息
                        await axios.put(`/api/markers/${this.form.id}`, {
                            latitude: this.form.latitude,
                            longitude: this.form.longitude,
                            value: this.form.value,
                            required_value: this.form.required_value
                        });

                        // 上传新图片（如果有）
                        if (this.form.files.length > 0) {
                            const formData = new FormData();
                            this.form.files.forEach(file => {
                                formData.append('images', file);
                            });
                            await axios.post(`/api/markers/${this.form.id}/images`, formData);
                        }

                        this.$message.success('更新成功');
                        this.closeForm();
                        this.loadMarkers();
                    } catch (error) {
                        this.$message.error('更新失败：' + (error.response?.data?.error || error.message));
                        console.error(error);
                    }
                },
                closeForm() {
                    this.showForm = false;
                    this.form.id = null;
                    this.form.latitude = null;
                    this.form.longitude = null;
                    this.form.value = 0;
                    this.form.required_value = 0;
                    this.form.files = [];
                    this.form.images = [];
                    this.isExistingMarker = false;
                    if (this.marker) {
                        this.marker.setMap(null);
                        this.marker = null;
                    }
                },
                // 添加图片缩放和拖拽相关的方法
                onWheel(e) {
                    const img = this.$refs.previewImg;
                    if (!img) return;
                    const rect = img.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    const relX = offsetX / rect.width;
                    const relY = offsetY / rect.height;
                    const step = 0.2;
                    let newScale = this.scale;
                    if (e.deltaY < 0) {
                        newScale = Math.min(this.scale + step, 5);
                    } else {
                        newScale = Math.max(this.scale - step, 0.2);
                    }
                    const dx = (relX - 0.5) * rect.width;
                    const dy = (relY - 0.5) * rect.height;
                    this.translateX -= dx * (newScale - this.scale) / this.scale;
                    this.translateY -= dy * (newScale - this.scale) / this.scale;
                    this.scale = newScale;
                },
                onMouseDown(e) {
                    this.dragging = true;
                    this.dragStartX = e.clientX;
                    this.dragStartY = e.clientY;
                    this.imgStartX = this.translateX;
                    this.imgStartY = this.translateY;
                },
                onMouseMove(e) {
                    if (!this.dragging) return;
                    this.translateX = this.imgStartX + (e.clientX - this.dragStartX);
                    this.translateY = this.imgStartY + (e.clientY - this.dragStartY);
                },
                onMouseUp() {
                    this.dragging = false;
                },
                logout() {
                    this.$confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('isLoggedIn');
                        window.location.href = '/login';
                    }).catch(() => {});
                }
            }
        });
    </script>
</body>
</html> 